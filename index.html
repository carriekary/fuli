<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>小野字幕君</title>

    <!-- DOCX 解析 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

    <style>
        :root{
          --header-height:100px;
          --accent:#355c7d;
          --subtitle-min-height:30px;
          --note-width:500px;
          --gutter:12px;
          --max-width:auto;
          --file-input-width: 200px;
        }
        *{box-sizing:border-box}
        html,body{height:100%;margin:0;padding:0;font-family:"Noto Serif CJK SC","Noto Serif CJK JP",Roboto,Arial,Noto Serif;background:#f5f5f5;color:#333}
        .header{
          position:fixed;top:0;left:0;right:0;height:var(--header-height);
          display:flex;align-items:center;justify-content:space-between;padding:12px 18px;
          background:rgba(44,62,80,0.95);color:#fff;z-index:999;box-shadow:0 3px 8px rgba(0,0,0,0.25);
        }
        .header-left{display:flex;flex-direction:column;gap:4px}
        .header-left h1{margin:0;font-size:20px}
        .header-left p{margin:0;font-size:12px;opacity:0.9}
        .file-search-container{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
        { flex: 0 0 var(--file-input-width); }, 
      .search-box{padding:6px 8px;border-radius:6px;border:1px solid #ddd;background:#fff;font-size:13px}
        .search-box{width:200px}
        
        /* 主內容 */
        main{padding:calc(var(--header-height) + 12px) 16px 140px;max-width:var(--max-width);margin:0 auto}
        #subtitles{display:block}
        
        /* 每行區塊：字幕框內為左右兩區（文字左、筆記右） */
        .row{display:block;margin:10px 0}
        .subtitle{
          background:#fff;padding:5px;border-radius:5px;
          box-shadow:0 2px 6px rgba(0,0,0,0.06);line-height:1;word-break:break-word;
          font-size:15px;min-height:var(--subtitle-min-height);position:relative;
          display:flex;flex-direction:row;gap:var(--gutter);align-items:flex-start;
          transition: background 0.12s ease;
        }
        .subtitle { border: 1px solid rgba(0,0,0,0.04); }
        
        /* 左側文字區：允許縮小但保留最小寬度 */
        .subtitle .text {
          flex: 1 1 auto;
          min-width: var(--min-text-width);
          white-space:pre-wrap;
          font-size:15px;
          color:#222;
          padding-right:6px;
          align-self:stretch;
          display:flex;
          align-items:center;
          transition: opacity 0.12s ease, transform 0.12s ease;
        }
        
        /* 右側內嵌筆記（在同一字幕框內） */
        .subtitle .note-inline {
          flex: 0 0 var(--note-width);
          min-width: auto;
          max-height:25px;
          padding:8px;
          border-radius:8px;
          border:1px none #e6e6e6;
          resize:vertical;
          font-size:13px;
          line-height:1.3;
          background:#fbfbfb;
          color:blue;
          box-shadow: inset 0 1px 0 rgba(0,0,0,0.02);
          box-sizing:border-box;
          align-self:flex-start;
          transition: flex-basis 0.18s ease, width 0.18s ease;
          overflow:auto;
        }
        
        /* 預設禁止從字幕拖選時誤選筆記文字 */
        .subtitle .note-inline,
        .subtitle .note-inline::selection {
          -webkit-user-select: none;
          -moz-user-select: none;
          -ms-user-select: none;
          user-select: none;
        }
        
        /* 當 note 有 selectable 類別時允許選取 */
        .subtitle .note-inline.selectable,
        .subtitle .note-inline.selectable::selection {
          -webkit-user-select: text;
          -moz-user-select: text;
          -ms-user-select: text;
          user-select: text;
        }
        
        /* 全局工具列（浮動） */
        .global-toolbar{
          position:fixed;top:calc(var(--header-height) + 10px);right:18px;
          background:rgba(255,255,255,0.98);border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.12);
          padding:8px;display:flex;gap:8px;align-items:center;z-index:1000;
        }
        .global-toolbar button{background:var(--accent);color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer;font-size:13px}
        .global-toolbar button.secondary{background:#6c757d}
        .global-toolbar .status{font-size:13px;color:#333;padding-left:6px}
        
        /* highlight */
        .highlight{background:yellow;font-weight:700}
        
        /* 響應式：窄螢幕時改為上下排列（文字上、筆記下） */
        @media (max-width:900px){
          .subtitle{flex-direction:column;gap:8px}
          .subtitle .note-inline{width:100%;flex:0 0 auto}
          .search-box{width:140px}
          main{padding-bottom:220px}
          .global-toolbar{right:12px;top:calc(var(--header-height) + 6px);left:12px;justify-content:space-between}
        }
        
        /* 匯出 HTML 的樣式（筆記內容為橙色） */
        .export-item{margin-bottom:18px}
        .export-header{display:flex;align-items:flex-start;gap:10px;margin-bottom:6px}
        .export-number{color:#333;min-width:28px;font-weight:normal}
        .export-note-subtitle{color:#222;font-weight:normal}
        .export-note-content{color:orange;margin:0;white-space:pre-wrap}
        hr{border:none;border-top:1px solid #eee;margin:18px 0}
    </style>
</head>

<body>
    <header class="header" role="banner">
        <div class="header-left">
            <h1>小野字幕君</h1>
            <p>支援：.srt / .ass / .docx / .txt / .pdf</p>
        </div>
        <div class="file-search-container" role="region" aria-label="檔案與搜尋">
            <input id="fileInput" type="file" accept=".ass,.srt,.docx,.txt,.pdf" />
            <input id="searchBox" class="search-box" type="text" placeholder="輸入搜尋內容..." />
        </div>
    </header>

    <!-- 全局工具列（僅保留 保存 與 匯出全部） -->
    <div class="global-toolbar" id="globalToolbar" aria-hidden="true" style="display:none;">
        <button id="saveBtn" type="button">保存</button>
        <button id="exportAllBtn" type="button" class="secondary">匯出</button>
        <div class="status" id="toolbarStatus">未選取筆記</div>
    </div>

    <main>
        <div id="subtitles" aria-live="polite"></div>
    </main>

    <script>
        /* PDF.js worker */
        if (typeof pdfjsLib !== 'undefined') {
          pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
        }
        
        /* 工具函式 */
        function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
        function escapeRegExp(str){ return str.replace(/[.*+?^${}()|[\\]\\\]/g,'\\\$&'); }
        function showError(msg){
          const c = document.getElementById('subtitles');
          c.innerHTML = `<div class="row"><div class="subtitle"><div class="text">${escapeHtml(msg)}</div></div></div>`;
        }
        
        /* localStorage key */
        function noteKey(fileName, index){
          const base = fileName ? fileName : 'anonymous';
          return `subtitle_note::${base}::${index}`;
        }
        
        /* 狀態 */
        let focusedIndex = null;
        let currentFileName = null;
        
        /* 顯示字幕（每行內嵌筆記在右側） */
        function displaySubtitles(subtitles, fileName){
          currentFileName = fileName || null;
          focusedIndex = null;
          updateToolbarVisibility();
          const container = document.getElementById('subtitles');
          if (!subtitles || subtitles.length === 0) {
            container.innerHTML = '';
            return;
          }
          container.innerHTML = '';
          subtitles.forEach((s, idx) => {
            const row = document.createElement('div');
            row.className = 'row';
            const subtitle = document.createElement('div');
            subtitle.className = 'subtitle ' + (idx % 2 === 0 ? 'color1' : 'color2');
        
            // 左側文字區
            const textDiv = document.createElement('div');
            textDiv.className = 'text';
            const text = s.text || '';
            textDiv.textContent = text;
            // 儲存原始文字於 dataset，供搜尋與匯出使用
            textDiv.dataset.original = text;
        
            // 右側內嵌筆記 textarea
            const note = document.createElement('textarea');
            note.className = 'note-inline';
            note.placeholder = ' ';
            note.dataset.index = idx;
        
            // 載入已保存的筆記（若有）
            try {
              const saved = localStorage.getItem(noteKey(fileName, idx));
              if (saved) note.value = saved;
            } catch (e) { /* ignore */ }
        
            // focus/blur 行為：focus 時筆記佔字幕框三分之一；blur 時恢復預設寬度
            note.addEventListener('focus', () => {
              focusedIndex = idx;
              note.classList.add('selectable');
              note.classList.add('expanded'); // CSS 設為 33%
              updateToolbarVisibility();
            });
        
            note.addEventListener('blur', () => {
              setTimeout(() => {
                const active = document.activeElement;
                const toolbar = document.getElementById('globalToolbar');
                // 若工具列被點擊，保留狀態直到工具列操作完成
                if (toolbar.contains(active)) return;
                note.classList.remove('expanded');
                note.classList.remove('selectable');
                focusedIndex = null;
                updateToolbarVisibility();
              }, 150);
            });
        
            // Ctrl/Cmd+S 快速保存
            note.addEventListener('keydown', (ev) => {
              if ((ev.ctrlKey || ev.metaKey) && ev.key.toLowerCase() === 's') {
                ev.preventDefault();
                try {
                  localStorage.setItem(noteKey(currentFileName, idx), note.value);
                  showTempStatus(`第 ${idx + 1} 行已保存`);
                } catch (e) { alert('保存失敗'); }
              }
            });
        
            subtitle.appendChild(textDiv);
            subtitle.appendChild(note);
            row.appendChild(subtitle);
            container.appendChild(row);
          });
        
          // 啟用選取切換與保護
          enableNoteSelectionToggle();
        }
        
        /* 解析器 */
        function parseSRT(content){
          if (!content) return [];
          const blocks = content.replace(/\r/g,'').split(/\n\n+/);
          const out = [];
          blocks.forEach(block => {
            const lines = block.split('\n').filter(l => l.trim() !== '');
            if (lines.length >= 2) {
              const textLines = lines.slice(2);
              if (textLines.length) out.push({ text: textLines.join(' ') });
            }
          });
          return out;
        }
        
        function parseASS(content){
          if (!content) return [];
          const lines = content.replace(/\r/g,'').split('\n');
          const dialogues = lines.filter(l => l.trim().startsWith('Dialogue:'));
          return dialogues.map(line => {
            const parts = line.split(',');
            const text = parts.slice(9).join(',').replace(/\\\N/g,' ').replace(/\\{.*?\\}/g,'').trim();
            return { text };
          });
        }
        
        function parseTXT(content){
          if (!content) return [];
          return content.split('\n').map(l => l.trim()).filter(l => l !== '').map(l => ({ text: l }));
        }
        
        function parseDOCX(arrayBuffer, callback){
          mammoth.convertToHtml({ arrayBuffer }).then(result => {
            const temp = document.createElement('div');
            temp.innerHTML = result.value || '';
            const ps = Array.from(temp.querySelectorAll('p')).map(p => p.textContent.trim()).filter(t => t !== '');
            callback(ps.map(t => ({ text: t })));
          }).catch(err => showError('DOCX 解析失敗：' + (err && err.message ? err.message : err)));
        }
        
        function parsePDF(arrayBuffer, callback){
          if (typeof pdfjsLib === 'undefined') { showError('PDF.js 未載入'); return; }
          const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
          loadingTask.promise.then(pdf => {
            const pagePromises = [];
            for (let i = 1; i <= pdf.numPages; i++) {
              pagePromises.push(
                pdf.getPage(i).then(page => page.getTextContent().then(textContent => {
                  const items = textContent.items || [];
                  let lines = [], current = [], lastY = null;
                  items.forEach(item => {
                    const y = (item.transform && item.transform[5] != null) ? item.transform[5] : null;
                    if (lastY === null || y === null || Math.abs(y - lastY) < 5) {
                      current.push(item.str);
                    } else {
                      if (current.length) lines.push(current.join(' '));
                      current = [item.str];
                    }
                    lastY = y;
                  });
                  if (current.length) lines.push(current.join(' '));
                  return lines.join('\n');
                }))
              );
            }
            Promise.all(pagePromises).then(pages => {
              const subtitles = pages.filter(p => p && p.trim() !== '').flatMap(p => p.split('\n').map(line => ({ text: line.trim() })));
              callback(subtitles);
            });
          }).catch(err => showError('PDF 解析失敗：' + (err && err.message ? err.message : err)));
        }
        
        /* 檔案上傳處理 */
        document.getElementById('fileInput').addEventListener('change', function(e){
          const file = e.target.files && e.target.files[0];
          if (!file) return;
          const ext = (file.name.split('.').pop() || '').toLowerCase();
          const reader = new FileReader();
          reader.onerror = () => showError('讀取檔案時發生錯誤。');
          reader.onload = (ev) => {
            try {
              if (ext === 'srt') displaySubtitles(parseSRT(ev.target.result), file.name);
              else if (ext === 'ass') displaySubtitles(parseASS(ev.target.result), file.name);
              else if (ext === 'txt') displaySubtitles(parseTXT(ev.target.result), file.name);
              else if (ext === 'docx') parseDOCX(ev.target.result, subs => displaySubtitles(subs, file.name));
              else if (ext === 'pdf') parsePDF(ev.target.result, subs => displaySubtitles(subs, file.name));
              else showError('不支援的檔案格式：' + ext);
            } catch (err) {
              showError('解析時發生錯誤：' + (err && err.message ? err.message : err));
            }
          };
          if (ext === 'docx' || ext === 'pdf') reader.readAsArrayBuffer(file);
          else reader.readAsText(file, 'utf-8');
        });
        
        /* 搜尋：顯示包含關鍵字的整行（字幕與內嵌筆記同時顯示） */
        document.getElementById('searchBox').addEventListener('input', function(){
          const q = this.value.trim();
          const rows = Array.from(document.querySelectorAll('.row'));
          if (!q) {
            rows.forEach(row => {
              const textDiv = row.querySelector('.subtitle .text');
              if (textDiv && textDiv.dataset.original) textDiv.innerHTML = escapeHtml(textDiv.dataset.original);
              row.style.display = '';
            });
            return;
          }
          const regex = new RegExp('(' + escapeRegExp(q) + ')', 'gi');
          rows.forEach((row, idx) => {
            const textDiv = row.querySelector('.subtitle .text');
            if (!textDiv) return;
            const original = textDiv.dataset.original || textDiv.textContent || '';
            if (original.match(regex)) {
              textDiv.innerHTML = escapeHtml(original).replace(regex, '<span class="highlight">$1</span>');
              row.style.display = '';
              if (idx === 0) row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
              row.style.display = 'none';
            }
          });
          if (typeof updateToolbarVisibility === 'function') updateToolbarVisibility();
          if (typeof enableNoteSelectionToggle === 'function') enableNoteSelectionToggle();
        });
        
        /* 筆記選取切換與保護（避免從字幕拖選到筆記） */
        function enableNoteSelectionToggle() {
          const notes = document.querySelectorAll('.note-inline');
          notes.forEach(note => {
            note.addEventListener('focus', () => note.classList.add('selectable'));
            note.addEventListener('blur', () => {
              setTimeout(() => {
                const active = document.activeElement;
                const toolbar = document.getElementById('globalToolbar');
                if (toolbar.contains(active)) return;
                note.classList.remove('selectable');
              }, 150);
            });
          });
        
          document.addEventListener('mouseup', () => {
            const sel = window.getSelection();
            if (!sel || sel.isCollapsed) return;
            try {
              const range = sel.getRangeAt(0);
              const start = range.startContainer;
              const end = range.endContainer;
              function insideNote(node) {
                if (!node) return false;
                if (node.nodeType === 3) node = node.parentElement;
                return node && node.closest && node.closest('.note-inline');
              }
              const sIn = insideNote(start);
              const eIn = insideNote(end);
              if ((sIn || eIn)) {
                const active = document.activeElement;
                if (!active || !active.closest || !active.closest('.note-inline')) {
                  sel.removeAllRanges();
                }
              }
            } catch (e) { /* ignore */ }
          });
        }
        
        /* 全局工具列行為 */
        const toolbar = document.getElementById('globalToolbar');
        const toolbarStatus = document.getElementById('toolbarStatus');
        function updateToolbarVisibility(){
          if (focusedIndex === null) {
            toolbar.style.display = 'none';
            toolbar.setAttribute('aria-hidden','true');
            toolbarStatus.textContent = '未選取筆記';
          } else {
            toolbar.style.display = 'flex';
            toolbar.setAttribute('aria-hidden','false');
            toolbarStatus.textContent = `編輯第 ${focusedIndex + 1} 行筆記`;
          }
        }
        function getFocusedNote(){
          if (focusedIndex === null) return null;
          return document.querySelector(`textarea.note-inline[data-index="${focusedIndex}"]`);
        }
        let statusTimer = null;
        function showTempStatus(msg){
          toolbarStatus.textContent = msg;
          clearTimeout(statusTimer);
          statusTimer = setTimeout(() => updateToolbarVisibility(), 1200);
        }
        
        /* 保存按鈕（保留） */
        document.getElementById('saveBtn').addEventListener('click', () => {
          const note = getFocusedNote();
          if (!note) { alert('請先點選一個筆記欄'); return; }
          try {
            localStorage.setItem(noteKey(currentFileName, focusedIndex), note.value);
            showTempStatus(`第 ${focusedIndex + 1} 行已保存`);
          } catch (err) { alert('保存失敗：' + (err && err.message ? err.message : err)); }
        });
        
        /* 匯出全部：僅匯出有筆記內容的行（包含該行字幕文字 + 筆記內容），並以編號 1., 2., 3. ... 標示；匯出為 HTML，筆記內容以橙色字體顯示 */
        document.getElementById('exportAllBtn').addEventListener('click', () => {
          // 只選取有非空白內容的 note
          const allNotes = Array.from(document.querySelectorAll('textarea.note-inline[data-index]'));
          const notesWithContent = allNotes.filter(n => (n.value || '').trim() !== '');
        
          if (!notesWithContent.length) { alert('沒有筆記可匯出'); return; }
        
          // 建立 HTML 內容，筆記以橙色字體顯示，並為每一筆加上編號（1., 2., 3., ...）
          const itemsHtml = notesWithContent.map((n, i) => {
            const num = i + 1;
            const row = n.closest('.row');
            let subtitleText = '';
            if (row) {
              const textDiv = row.querySelector('.subtitle .text');
              if (textDiv) subtitleText = (textDiv.dataset.original || textDiv.textContent || '').trim();
            }
            const noteText = escapeHtml(n.value.trim());
            if (subtitleText) {
              return `<div class="export-item">
                        <div class="export-header">
                          <div class="export-number">${num}.</div>
                          <div class="export-note-subtitle">${escapeHtml(subtitleText)}</div>
                        </div>
                        <div class="export-note-content">${noteText}</div>
                      </div>`;
            } else {
              return `<div class="export-item">
                        <div class="export-header">
                          <div class="export-number">${num}.</div>
                          <div class="export-note-subtitle"></div>
                        </div>
                        <div class="export-note-content">${noteText}</div>
                      </div>`;
            }
          }).join('\n<hr/>\n');
        
          const html = `<!doctype html>
        <html  lang="zh">
        <head>
        <meta charset="utf-8">
        <title>${escapeHtml((currentFileName || 'notes'))} - 筆記匯出</title>
        <style>
        body{font-family:Arial,Helvetica,sans-serif;padding:18px;color:#222;background:#fff}
        .export-item{margin-bottom:18px}
        .export-header{display:flex;align-items:flex-start;gap:10px;margin-bottom:6px}
        .export-number{color:#333;min-width:28px;font-weight:normal}
        .export-note-subtitle{color:#222;font-weight:normal}
        .export-note-content{color:orange;margin:0;white-space:pre-wrap}
        hr{border:none;border-top:1px solid #eee;margin:18px 0}
        </style>
        </head>
        <body>
        ${itemsHtml}
        </body>
        </html>`;
        
          const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${(currentFileName || 'notes')}_all.html`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          showTempStatus('全部筆記已匯出（HTML，筆記為橙色）');
        });
        
        /* 當 note focus 時設定 focusedIndex（displaySubtitles 已綁定，但保險起見也監聽） */
        document.addEventListener('focusin', (e) => {
          const el = e.target;
          if (el && el.dataset && el.dataset.index != null) {
            focusedIndex = Number(el.dataset.index);
            updateToolbarVisibility();
          }
        });
        
        /* 初始：不顯示任何提示內容，等待使用者上傳檔案 */
        document.addEventListener('DOMContentLoaded', () => {
          const c = document.getElementById('subtitles');
          c.innerHTML = '';
        });
    </script>
</body>
</html>
