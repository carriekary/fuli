<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>小野字幕君</title>

    <!-- DOCX 解析 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

    <style>
        :root {
          --header-height: 100px;
          --accent: #355c7d;
          --subtitle-min-height: 30px;
          --box-width: 600px; /* 统一框体宽度 */
          --gutter: 12px;
          --max-width: auto;
          --file-input-width: 200px;
        }
        
        * {
          box-sizing: border-box;
        }
        
        html,
        body {
          height: 100%;
          margin: 0;
          padding: 0;
          font-family: "Noto Serif CJK SC", "Noto Serif CJK JP", Roboto, Arial, Noto Serif;
          background: #f5f5f5;
          color: #333;
        }
        
        .header {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          height: var(--header-height);
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 12px 18px;
          background: rgba(44, 62, 80, 0.95);
          color: #fff;
          z-index: 999;
          box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);
        }
        
        .header-left {
          display: flex;
          flex-direction: column;
          gap: 4px;
        }
        
        .header-left h1 {
          margin: 0;
          font-size: 20px;
        }
        
        .header-left p {
          margin: 0;
          font-size: 12px;
          opacity: 0.9;
        }
        
        .file-search-container {
          display: flex;
          gap: 10px;
          align-items: center;
          flex-wrap: wrap;
        }
        
        .search-box {
          padding: 6px 8px;
          border-radius: 6px;
          border: 1px solid #ddd;
          background: #fff;
          font-size: 13px;
          width: 200px;
        }
        
        /* 主內容 */
        main {
          padding: calc(var(--header-height) + 12px) 16px 140px;
          max-width: var(--max-width);
          margin: 0 auto;
        }
        
        #subtitles {
          display: block;
        }
        
        /* 每行區塊 */
        .row {
          display: block;
          margin: 5px 0;
        }
        
        .subtitle {
          background: #fff;
          padding: 8px 12px;
          border-radius: 8px;
          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
          line-height: 1;
          word-break: break-word;
          font-size: 15px;
          min-height: var(--subtitle-min-height);
          display: flex;
          flex-direction: row;
          gap: var(--gutter);
          align-items: stretch; /* 确保子元素等高 */
          border: 1px solid rgba(0, 0, 0, 0.05);
          transition: all 0.2s ease;
        }
        
        .subtitle:hover {
          box-shadow: 0 3px 10px rgba(0, 0, 0, 0.12);
        }
        
        .subtitle.has-note {
          border-left: 4px solid #ff9800;
        }
        
        /* 左側文字框 - 与笔记框同宽 */
        .text-box {
          flex: 0 0 var(--box-width);
          height: 35px;
          padding: 8px 12px;
          border-radius: 6px;
          border: 1px solid #e0e0e0;
          background: #f9f9f9;
          font-size: 16px;
          line-height: 1.4;
          color: #222;
          white-space: pre-wrap;
          word-break: break-word;
          display: flex;
          align-items: center;
          box-sizing: border-box;
          overflow: hidden;
        }
        
        /* 右側筆記框 - 与文字框同宽 */
        .note-box {
          flex: 0 0 var(--box-width);
          height: 35px; /* 固定初始高度，只顯示一行 */
          max-height: 100px;
          padding: 8px 12px;
          border-radius: 6px;
          border: 1px solid #ddd;
          background: #fff;
          font-size: 15px;
          line-height: 1.4;
          color: #333;
          box-sizing: border-box;
          resize: vertical;
          font-family: inherit;
          transition: all 0.2s ease;
          overflow-y: hidden; /* 初始隱藏滾動條 */
        }
        
        /* 筆記有內容時的樣式 */
        .note-box.has-content {
          border-color: #ff9800;
          background: #fff8e1;
          color: #e65100;
          box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* 編輯時的樣式 */
        .note-box:focus {
          outline: none;
          border-color: var(--accent);
          background: #fff;
          color: #333;
          box-shadow: 0 0 0 3px rgba(53, 92, 125, 0.2);
        }
        
        .note-box.has-content:focus {
          background: #fff;
          color: #333;
        }
        
        /* 文件信息 */
        .file-info {
          position: fixed;
          bottom: 20px;
          right: 20px;
          background: rgba(255, 255, 255, 0.95);
          padding: 8px 12px;
          border-radius: 6px;
          font-size: 12px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.15);
          z-index: 100;
          border: 1px solid #ddd;
          max-width: 300px;
        }
        
        /* highlight */
        .highlight {
          background: yellow;
          font-weight: 700;
        }
        
        /* 加載指示器 */
        .loading {
          text-align: center;
          padding: 40px;
          color: #666;
          font-size: 14px;
        }
        
        /* 匯出按鈕 */
        .export-btn {
          position: fixed;
          bottom: 20px;
          right: 20px;
          background: var(--accent);
          color: white;
          border: none;
          padding: 10px 16px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 14px;
          z-index: 100;
          box-shadow: 0 2px 8px rgba(0,0,0,0.2);
          transition: all 0.2s ease;
        }
        
        .export-btn:hover {
          background: #2a4a6a;
          transform: translateY(-1px);
        }
        
        /* 全局狀態指示器 */
        .global-status {
          position: fixed;
          top: calc(var(--header-height) + 10px);
          right: 18px;
          background: rgba(255, 255, 255, 0.98);
          border-radius: 6px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
          padding: 6px 10px;
          font-size: 12px;
          color: #333;
          z-index: 1000;
          display: none;
        }
        
        .global-status.show {
          display: block;
        }
        
        /* 進度條 */
        .progress-container {
          position: fixed;
          top: var(--header-height);
          left: 0;
          right: 0;
          height: 4px;
          background: #f0f0f0;
          z-index: 999;
          display: none;
        }
        
        .progress-bar {
          height: 100%;
          background: var(--accent);
          width: 0%;
          transition: width 0.3s ease;
        }
        
        /* 響應式 */
        @media (max-width: 1200px) {
          :root {
            --box-width: 350px; /* 中等屏幕调整宽度 */
          }
        }
        
        @media (max-width: 900px) {
          .subtitle {
            flex-direction: column;
            gap: 10px;
            padding: 10px;
          }
          
          .text-box,
          .note-box {
            flex: 0 0 auto;
            width: 100%;
          }
          
          .search-box {
            width: 140px;
          }
          
          main {
            padding-bottom: 180px;
          }
          
          .note-box {
            max-height: 200px;
          }
        }
        
        @media (max-width: 600px) {
          :root {
            --box-width: 100%; /* 小屏幕使用100%宽度 */
          }
        }
    </style>
</head>

<body>
    <header class="header" role="banner">
        <div class="header-left">
            <h1>小野字幕君</h1>
            <p>支援：.srt / .ass / .docx / .txt / .pdf</p>
        </div>
        <div class="file-search-container" role="region" aria-label="檔案與搜尋">
            <input id="fileInput" type="file" accept=".ass,.srt,.docx,.txt,.pdf" />
            <input id="searchBox" class="search-box" type="text" placeholder="輸入搜尋內容" />
        </div>
    </header>

    <!-- 進度條 -->
    <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <!-- 全局狀態指示器 -->
    <div class="global-status" id="globalStatus"></div>

    <!-- 文件信息 -->
    <div class="file-info" id="fileInfo" style="display:none;"></div>

    <!-- 匯出按鈕 -->
    <button class="export-btn" id="exportBtn" style="display:none;">匯出筆記</button>

    <main>
        <div id="subtitles" aria-live="polite"></div>
    </main>

    <script>
        // ==================== 核心狀態 ====================
        let currentFileName = null;
        let allSubtitles = [];
        let notesData = {}; // {index: noteText}
        let noteCount = 0; // 筆記數量統計
        
        // ==================== 工具函數 ====================
        function debounce(func, wait) {
          let timeout;
          return function executedFunction(...args) {
            const later = () => {
              clearTimeout(timeout);
              func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
          };
        }
        
        function escapeHtml(s) {
          return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }
        
        function escapeRegExp(str) {
          return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        function showError(msg) {
          const c = document.getElementById('subtitles');
          c.innerHTML = `<div class="loading" style="color:#d32f2f;">${escapeHtml(msg)}</div>`;
        }
        
        function showLoading(msg = '加載中...') {
          const c = document.getElementById('subtitles');
          c.innerHTML = `<div class="loading">${escapeHtml(msg)}</div>`;
        }
        
        function updateFileInfo(msg, duration = 3000) {
          const fileInfo = document.getElementById('fileInfo');
          fileInfo.textContent = msg;
          fileInfo.style.display = 'block';
          
          if (duration > 0) {
            setTimeout(() => {
              fileInfo.style.display = 'none';
            }, duration);
          }
        }
        
        function showGlobalStatus(msg, duration = 2000) {
          const status = document.getElementById('globalStatus');
          status.textContent = msg;
          status.classList.add('show');
          
          setTimeout(() => {
            status.classList.remove('show');
          }, duration);
        }
        
        function updateProgress(percent, msg = '') {
          const container = document.getElementById('progressContainer');
          const bar = document.getElementById('progressBar');
          
          container.style.display = 'block';
          bar.style.width = percent + '%';
          
          if (msg) {
            updateFileInfo(msg);
          }
          
          if (percent >= 100) {
            setTimeout(() => {
              container.style.display = 'none';
            }, 500);
          }
        }
        
        function updateNoteCount() {
          noteCount = Object.keys(notesData).length;
          if (noteCount > 0) {
            document.getElementById('exportBtn').style.display = 'block';
            showGlobalStatus(`已有 ${noteCount} 條筆記`);
          } else {
            document.getElementById('exportBtn').style.display = 'none';
          }
        }
        
        // ==================== 自動調整筆記框高度 ====================
        function autoResizeTextarea(textarea) {
          // 保存當前的滾動位置
          const scrollTop = window.scrollY;
          
          // 重置高度為一行
          textarea.style.height = '34px';
          
          // 獲取計算後的樣式
          const computedStyle = window.getComputedStyle(textarea);
          let maxHeight = parseInt(computedStyle.maxHeight, 10);
          
          // 如果maxHeight不是數字或者為0，則使用默認的300
          if (isNaN(maxHeight) || maxHeight <= 0) {
            maxHeight = 300;
          }
          
          // 計算新高度（scrollHeight包含padding）
          const newHeight = Math.min(textarea.scrollHeight, maxHeight);
          
          // 確保最小高度為34px（一行的高度）
          const finalHeight = Math.max(newHeight, 34);
          
          // 設置新高度
          textarea.style.height = finalHeight + 'px';
          
          // 如果有滾動條，設置overflow為auto
          if (textarea.scrollHeight > maxHeight) {
            textarea.style.overflowY = 'auto';
          } else {
            textarea.style.overflowY = 'hidden';
          }
          
          // 恢復滾動位置
          window.scrollTo(0, scrollTop);
        }
        
        // ==================== 解析器函數 ====================
        function parseSRT(content) {
          if (!content) return [];
          const blocks = content.replace(/\r/g, '').split(/\n\n+/);
          const out = [];
          
          blocks.forEach(block => {
            const lines = block.split('\n').filter(l => l.trim() !== '');
            if (lines.length >= 2) {
              const textLines = lines.slice(2);
              if (textLines.length) out.push({ text: textLines.join(' ') });
            }
          });
          
          return out;
        }
        
        function parseASS(content) {
          if (!content) return [];
          const lines = content.replace(/\r/g, '').split('\n');
          const dialogues = lines.filter(l => l.trim().startsWith('Dialogue:'));
          
          return dialogues.map(line => {
            const parts = line.split(',');
            const text = parts.slice(9).join(',').replace(/\\N/g, ' ').replace(/\{.*?\}/g, '').trim();
            return { text };
          });
        }
        
        function parseTXT(content) {
          if (!content) return [];
          return content.split('\n').map(l => l.trim()).filter(l => l !== '').map(l => ({ text: l }));
        }
        
        function parseDOCX(arrayBuffer, callback) {
          updateProgress(30, '解析 DOCX 文件中...');
          
          mammoth.convertToHtml({ arrayBuffer }).then(result => {
            const temp = document.createElement('div');
            temp.innerHTML = result.value || '';
            const ps = Array.from(temp.querySelectorAll('p')).map(p => p.textContent.trim()).filter(t => t !== '');
            callback(ps.map(t => ({ text: t })));
            updateProgress(100, 'DOCX 解析完成');
          }).catch(err => {
            showError('DOCX 解析失敗：' + (err && err.message ? err.message : err));
            updateProgress(0);
          });
        }
        
        function parsePDF(arrayBuffer, callback) {
          if (typeof pdfjsLib === 'undefined') { 
            showError('PDF.js 未載入'); 
            updateProgress(0);
            return; 
          }
          
          updateProgress(20, '載入 PDF 文件中...');
          
          // PDF.js worker
          pdfjsLib.GlobalWorkerOptions.workerSrc = 
            'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
          
          const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
          
          loadingTask.promise.then(pdf => {
            updateProgress(40, `PDF 共 ${pdf.numPages} 頁，正在解析...`);
            
            const pagePromises = [];
            for (let i = 1; i <= pdf.numPages; i++) {
              pagePromises.push(
                pdf.getPage(i).then(page => 
                  page.getTextContent().then(textContent => {
                    const items = textContent.items || [];
                    let lines = [], current = [], lastY = null;
                    
                    items.forEach(item => {
                      const y = (item.transform && item.transform[5] != null) ? item.transform[5] : null;
                      
                      if (lastY === null || y === null || Math.abs(y - lastY) < 5) {
                        current.push(item.str);
                      } else {
                        if (current.length) lines.push(current.join(' '));
                        current = [item.str];
                      }
                      lastY = y;
                    });
                    
                    if (current.length) lines.push(current.join(' '));
                    return lines.join('\n');
                  })
                )
              );
            }
            
            Promise.all(pagePromises).then(pages => {
              updateProgress(80, '整理 PDF 內容...');
              
              const subtitles = pages.filter(p => p && p.trim() !== '').flatMap(p => 
                p.split('\n').map(line => ({ text: line.trim() })).filter(s => s.text !== '')
              );
              
              callback(subtitles);
              updateProgress(100, 'PDF 解析完成');
            });
          }).catch(err => {
            showError('PDF 解析失敗：' + (err && err.message ? err.message : err));
            updateProgress(0);
          });
        }
        
        // ==================== 快速生成字幕行HTML ====================
        function createSubtitleRowHTML(subtitle, index) {
          const hasNote = notesData[index] ? 'has-note' : '';
          const noteContent = notesData[index] || '';
          const noteHasContent = noteContent ? 'has-content' : '';
          const escapedText = escapeHtml(subtitle.text || '');
          const escapedNote = escapeHtml(noteContent);
          
          // 修復：移除textarea標籤內的換行和縮進
          return `<div class="row" data-index="${index}">
              <div class="subtitle ${hasNote}">
                <div class="text-box" data-original="${escapedText}">
                  ${escapedText}
                </div>
                <textarea class="note-box ${noteHasContent}" data-index="${index}" placeholder="">${escapedNote}</textarea>
              </div>
            </div>`;
        }
        
        // ==================== 批量渲染所有字幕行 ====================
        function renderAllSubtitles(subtitles) {
          const container = document.getElementById('subtitles');
          const totalRows = subtitles.length;
          
          // 清空容器
          container.innerHTML = '';
          
          // 如果沒有字幕，直接返回
          if (totalRows === 0) {
            updateFileInfo('沒有字幕內容', 3000);
            return;
          }
          
          // 顯示加載進度
          updateProgress(0, '開始渲染字幕...');
          
          // 一次性生成所有HTML
          let html = '';
          for (let i = 0; i < totalRows; i++) {
            html += createSubtitleRowHTML(subtitles[i], i);
          }
          
          // 一次性添加到DOM
          container.innerHTML = html;
          
          // 更新進度
          updateProgress(100, `已渲染 ${totalRows} 行字幕`);
          
          // 為所有筆記框添加事件監聽器
          setTimeout(() => {
            const noteBoxes = container.querySelectorAll('.note-box');
            noteBoxes.forEach((noteBox, i) => {
              const index = parseInt(noteBox.dataset.index);
              const subtitleDiv = noteBox.closest('.subtitle');
              const textBox = subtitleDiv.querySelector('.text-box');
              
              setupNoteBoxEvents(noteBox, subtitleDiv, textBox, index);
              
              // 如果筆記框有內容，調整高度
              if (noteBox.value && noteBox.value.trim()) {
                // 使用setTimeout確保DOM已經完全渲染
                setTimeout(() => {
                  autoResizeTextarea(noteBox);
                }, 10);
              }
            });
            
            updateFileInfo(`已加載全部 ${totalRows} 行字幕`, 3000);
          }, 0);
        }
        
        // ==================== 設置筆記框事件 ====================
        function setupNoteBoxEvents(noteBox, subtitleDiv, textBox, index) {
          // 筆記框輸入時自動調整高度
          noteBox.addEventListener('input', function() {
            autoResizeTextarea(this);
            
            // 原有的狀態更新邏輯
            const trimmedValue = noteBox.value.trim();
            if (trimmedValue) {
              subtitleDiv.classList.add('has-note');
            } else {
              subtitleDiv.classList.remove('has-note');
            }
          });
          
          // 筆記框獲得焦點時
          noteBox.addEventListener('focus', function() {
            // 獲得焦點時也調整一次
            setTimeout(() => {
              autoResizeTextarea(this);
            }, 10);
            
            if (noteBox.value.trim()) {
              noteBox.classList.remove('has-content');
            }
          });
        
          // 筆記框失去焦點時
          noteBox.addEventListener('blur', debounce(function() {
            const trimmedValue = noteBox.value.trim();
            
            // 保存筆記
            if (trimmedValue) {
              notesData[index] = trimmedValue;
              noteBox.classList.add('has-content');
              subtitleDiv.classList.add('has-note');
              
              // 顯示保存狀態
              showGlobalStatus(`第 ${index + 1} 行筆記已保存`, 1500);
            } else {
              // 如果內容為空，刪除筆記
              delete notesData[index];
              noteBox.classList.remove('has-content');
              subtitleDiv.classList.remove('has-note');
              
              // 顯示刪除狀態
              showGlobalStatus(`第 ${index + 1} 行筆記已刪除`, 1500);
            }
            
            // 更新筆記計數
            updateNoteCount();
          }, 300));
        
          // 快捷鍵：Ctrl+Enter保存
          noteBox.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
              e.preventDefault();
              noteBox.blur(); // 觸發blur事件進行保存
            }
          });
        
          // 雙擊文字框也可以聚焦筆記框
          textBox.addEventListener('dblclick', function() {
            noteBox.focus();
            noteBox.selectionStart = noteBox.value.length;
          });
        }
        
        // ==================== 顯示字幕（快速全部加載） ====================
        function displaySubtitles(subtitles, fileName) {
          currentFileName = fileName || null;
          allSubtitles = subtitles;
          notesData = {};
          noteCount = 0;
          
          const container = document.getElementById('subtitles');
          
          if (!subtitles || subtitles.length === 0) {
            container.innerHTML = '';
            updateFileInfo('沒有字幕內容', 3000);
            return;
          }
          
          showLoading(`正在加載 ${subtitles.length} 行字幕...`);
          
          // 使用setTimeout確保UI有機會更新
          setTimeout(() => {
            renderAllSubtitles(subtitles);
            
            // 更新匯出按鈕狀態
            updateNoteCount();
          }, 10);
        }
        
        // ==================== 文件上傳處理 ====================
        document.getElementById('fileInput').addEventListener('change', function(e) {
          const file = e.target.files && e.target.files[0];
          if (!file) return;
          
          const ext = (file.name.split('.').pop() || '').toLowerCase();
          const reader = new FileReader();
          
          reader.onerror = () => {
            showError('讀取檔案時發生錯誤');
            updateProgress(0);
          };
          
          reader.onload = (ev) => {
            try {
              currentFileName = file.name;
              updateProgress(10, '開始處理文件...');
              
              if (ext === 'srt') {
                const subtitles = parseSRT(ev.target.result);
                displaySubtitles(subtitles, file.name);
                updateProgress(100, 'SRT 解析完成');
              } else if (ext === 'ass') {
                const subtitles = parseASS(ev.target.result);
                displaySubtitles(subtitles, file.name);
                updateProgress(100, 'ASS 解析完成');
              } else if (ext === 'txt') {
                const subtitles = parseTXT(ev.target.result);
                displaySubtitles(subtitles, file.name);
                updateProgress(100, 'TXT 解析完成');
              } else if (ext === 'docx') {
                parseDOCX(ev.target.result, subs => {
                  displaySubtitles(subs, file.name);
                });
              } else if (ext === 'pdf') {
                parsePDF(ev.target.result, subs => {
                  displaySubtitles(subs, file.name);
                });
              } else {
                showError('不支援的檔案格式：' + ext);
                updateProgress(0);
              }
            } catch (err) {
              showError('解析時發生錯誤：' + (err && err.message ? err.message : err));
              updateProgress(0);
            }
          };
          
          if (ext === 'docx' || ext === 'pdf') {
            reader.readAsArrayBuffer(file);
          } else {
            reader.readAsText(file, 'utf-8');
          }
        });
        
        // ==================== 搜索功能 ====================
        document.getElementById('searchBox').addEventListener('input', debounce(function() {
          const query = this.value.trim();
          const rows = document.querySelectorAll('.row');
          
          if (!query) {
            rows.forEach(row => {
              const textBox = row.querySelector('.text-box');
              if (textBox && textBox.dataset.original) {
                textBox.textContent = textBox.dataset.original;
              }
              row.style.display = '';
            });
            return;
          }
          
          const regex = new RegExp('(' + escapeRegExp(query) + ')', 'gi');
          let firstMatch = null;
          let matchCount = 0;
          
          rows.forEach(row => {
            const textBox = row.querySelector('.text-box');
            if (!textBox) return;
            
            const original = textBox.dataset.original || textBox.textContent || '';
            
            if (original.match(regex)) {
              textBox.innerHTML = escapeHtml(original).replace(regex, '<span class="highlight">$1</span>');
              row.style.display = '';
              matchCount++;
              
              if (firstMatch === null) {
                firstMatch = row;
              }
            } else {
              row.style.display = 'none';
            }
          });
          
          if (firstMatch) {
            firstMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
            showGlobalStatus(`找到 ${matchCount} 個匹配結果`, 2000);
          } else if (query) {
            showGlobalStatus(`未找到匹配內容`, 2000);
          }
        }, 300));
        
        // ==================== 導出功能 ====================
        document.getElementById('exportBtn').addEventListener('click', function() {
          const notesWithContent = Object.entries(notesData)
            .filter(([index, note]) => note && note.trim() !== '')
            .sort(([a], [b]) => a - b);
          
          if (notesWithContent.length === 0) {
            alert('沒有筆記可匯出');
            return;
          }
          
          const itemsHtml = notesWithContent.map(([index, note], i) => {
            const num = i + 1;
            const subtitle = allSubtitles[index];
            const subtitleText = subtitle ? subtitle.text : '';
            
            return `
              <div class="export-item">
                <div class="export-header">
                  <div class="export-number">${num}.</div>
                  <div class="export-note-subtitle">${escapeHtml(subtitleText)}</div>
                </div>
                <div class="export-note-content">${escapeHtml(note.trim())}</div>
              </div>
            `;
          }).join('\n<hr/>\n');
          
          const html = `<!doctype html>
            <html lang="zh">
            <head>
              <meta charset="utf-8">
              <title>${escapeHtml(currentFileName || 'notes')} - 筆記匯出</title>
              <style>
                body{font-family:Arial,sans-serif;padding:20px;color:#222;background:#fff}
                .export-item{margin-bottom:20px}
                .export-header{display:flex;align-items:flex-start;gap:10px;margin-bottom:8px}
                .export-number{color:#333;min-width:28px;font-weight:bold}
                .export-note-subtitle{color:#222;font-weight:normal;line-height:1.4}
                .export-note-content{color:#e67e22;margin:0;white-space:pre-wrap;line-height:1.5}
                hr{border:none;border-top:1px solid #eee;margin:20px 0}
              </style>
            </head>
            <body>
              <h2>${escapeHtml(currentFileName || '字幕筆記')}</h2>
              <p>共 ${notesWithContent.length} 條筆記，導出時間: ${new Date().toLocaleString()}</p>
              ${itemsHtml}
            </body>
            </html>`;
          
          const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${(currentFileName || 'notes').replace(/\.[^/.]+$/, "")}_筆記導出.html`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          
          showGlobalStatus(`已導出 ${notesWithContent.length} 條筆記`, 3000);
        });
        
        // ==================== 頁面離開確認 ====================
        window.addEventListener('beforeunload', function(e) {
          if (noteCount > 0) {
            e.preventDefault();
            e.returnValue = `您有 ${noteCount} 條未導出的筆記，確定要離開嗎？`;
            return e.returnValue;
          }
        });
        
        // ==================== 初始化 ====================
        document.addEventListener('DOMContentLoaded', function() {
          updateFileInfo('請上傳字幕文件（支援 .srt, .ass, .txt, .docx, .pdf）', 5000);
        });
    </script>
</body>
</html>
